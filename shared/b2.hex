00000000: 2369 6e63 6c75 6465 2022 436c 6965 6e74  #include "Client
00000010: 2e68 220a 0a43 6c69 656e 743a 3a43 6c69  .h"..Client::Cli
00000020: 656e 7428 290a 7b0a 0a7d 0a0a 436c 6965  ent().{..}..Clie
00000030: 6e74 3a3a 7e43 6c69 656e 7428 290a 7b0a  nt::~Client().{.
00000040: 2020 2020 636c 6f73 6528 6d5f 736f 636b      close(m_sock
00000050: 496e 666f 2e73 6f63 6b29 3b0a 7d0a 0a76  Info.sock);.}..v
00000060: 6f69 6420 436c 6965 6e74 3a3a 496e 6974  oid Client::Init
00000070: 536f 636b 2853 4f43 4b5f 494e 464f 2620  Sock(SOCK_INFO& 
00000080: 736f 636b 496e 666f 2c20 6368 6172 202a  sockInfo, char *
00000090: 6970 2c20 6368 6172 202a 706f 7274 290a  ip, char *port).
000000a0: 7b0a 2020 2020 736f 636b 496e 666f 2e73  {.    sockInfo.s
000000b0: 6f63 6b20 3d20 736f 636b 6574 2850 465f  ock = socket(PF_
000000c0: 494e 4554 2c20 534f 434b 5f53 5452 4541  INET, SOCK_STREA
000000d0: 4d2c 2049 5050 524f 544f 5f54 4350 293b  M, IPPROTO_TCP);
000000e0: 0a20 2020 2069 6628 736f 636b 496e 666f  .    if(sockInfo
000000f0: 2e73 6f63 6b20 3d3d 202d 3129 0a20 2020  .sock == -1).   
00000100: 2020 2020 2065 7869 745f 6d65 7373 6167       exit_messag
00000110: 6528 2273 6f63 6b65 7428 2920 6572 726f  e("socket() erro
00000120: 7221 2229 3b0a 0a20 2020 2053 6574 4164  r!");..    SetAd
00000130: 6472 2873 6f63 6b49 6e66 6f2e 6164 6472  dr(sockInfo.addr
00000140: 2c20 6970 2c20 706f 7274 293b 0a7d 0a0a  , ip, port);.}..
00000150: 766f 6964 2043 6c69 656e 743a 3a53 6574  void Client::Set
00000160: 4164 6472 2873 7472 7563 7420 736f 636b  Addr(struct sock
00000170: 6164 6472 5f69 6e26 2061 6464 722c 2063  addr_in& addr, c
00000180: 6861 722a 2069 702c 2063 6861 722a 2070  har* ip, char* p
00000190: 6f72 7429 0a7b 0a20 2020 206d 656d 7365  ort).{.    memse
000001a0: 7428 2661 6464 722c 2030 2c20 7369 7a65  t(&addr, 0, size
000001b0: 6f66 2861 6464 7229 293b 0a20 2020 2061  of(addr));.    a
000001c0: 6464 722e 7369 6e5f 6661 6d69 6c79 203d  ddr.sin_family =
000001d0: 2041 465f 494e 4554 3b0a 0a20 2020 2069   AF_INET;..    i
000001e0: 6628 6970 203d 3d20 4e55 4c4c 290a 2020  f(ip == NULL).  
000001f0: 2020 2020 2020 6164 6472 2e73 696e 5f61        addr.sin_a
00000200: 6464 722e 735f 6164 6472 203d 2068 746f  ddr.s_addr = hto
00000210: 6e6c 2849 4e41 4444 525f 414e 5929 3b0a  nl(INADDR_ANY);.
00000220: 2020 2020 656c 7365 0a20 2020 2020 2020      else.       
00000230: 2061 6464 722e 7369 6e5f 6164 6472 2e73   addr.sin_addr.s
00000240: 5f61 6464 7220 3d20 696e 6574 5f61 6464  _addr = inet_add
00000250: 7228 6970 293b 0a0a 2020 2020 6164 6472  r(ip);..    addr
00000260: 2e73 696e 5f70 6f72 7420 3d20 6874 6f6e  .sin_port = hton
00000270: 7328 6174 6f69 2870 6f72 7429 293b 0a7d  s(atoi(port));.}
00000280: 0a0a 0a76 6f69 6420 436c 6965 6e74 3a3a  ...void Client::
00000290: 496e 6974 6961 6c69 7a65 436c 6965 6e74  InitializeClient
000002a0: 2863 6861 7220 2a69 702c 2063 6861 7220  (char *ip, char 
000002b0: 2a70 6f72 742c 2063 6861 722a 2066 6f6c  *port, char* fol
000002c0: 6465 7229 0a7b 0a20 2020 2049 6e69 7453  der).{.    InitS
000002d0: 6f63 6b28 6d5f 736f 636b 496e 666f 2c20  ock(m_sockInfo, 
000002e0: 6970 2c20 706f 7274 293b 0a20 2020 2053  ip, port);.    S
000002f0: 6574 5368 6172 6564 466f 6c64 6572 2866  etSharedFolder(f
00000300: 6f6c 6465 7229 3b0a 2020 2020 5365 7449  older);.    SetI
00000310: 6f76 4275 6666 6572 2829 3b0a 7d0a 0a76  ovBuffer();.}..v
00000320: 6f69 6420 436c 6965 6e74 3a3a 496e 6974  oid Client::Init
00000330: 6961 6c69 7a65 5365 7276 6572 2863 6861  ializeServer(cha
00000340: 722a 2070 6f72 7429 0a7b 0a20 2020 2053  r* port).{.    S
00000350: 6574 506f 7274 2870 6f72 7429 3b0a 2020  etPort(port);.  
00000360: 2020 5365 7441 6464 7228 6d5f 6d79 536f    SetAddr(m_mySo
00000370: 636b 496e 666f 2e61 6464 722c 204e 554c  ckInfo.addr, NUL
00000380: 4c2c 2070 6f72 7429 3b0a 7d0a 0a0a 766f  L, port);.}...vo
00000390: 6964 2043 6c69 656e 743a 3a41 736b 536f  id Client::AskSo
000003a0: 636b 6574 2853 4f43 4b5f 494e 464f 2620  cket(SOCK_INFO& 
000003b0: 736f 636b 496e 666f 2c20 6368 6172 202a  sockInfo, char *
000003c0: 6970 2c20 6368 6172 202a 706f 7274 290a  ip, char *port).
000003d0: 7b0a 2020 2020 6966 2863 6f6e 6e65 6374  {.    if(connect
000003e0: 2873 6f63 6b49 6e66 6f2e 736f 636b 2c20  (sockInfo.sock, 
000003f0: 2873 7472 7563 7420 736f 636b 6164 6472  (struct sockaddr
00000400: 2a29 2026 736f 636b 496e 666f 2e61 6464  *) &sockInfo.add
00000410: 722c 2073 697a 656f 6628 736f 636b 496e  r, sizeof(sockIn
00000420: 666f 2e61 6464 7229 2920 3d3d 202d 3129  fo.addr)) == -1)
00000430: 0a20 2020 2020 2020 2065 7869 745f 6d65  .        exit_me
00000440: 7373 6167 6528 2263 6f6e 6e65 6374 2829  ssage("connect()
00000450: 2065 7272 6f72 2122 293b 0a20 2020 2065   error!");.    e
00000460: 6c73 650a 2020 2020 2020 2020 7075 7473  lse.        puts
00000470: 2822 636f 6e6e 6563 7465 642e 2e2e 2022  ("connected... "
00000480: 293b 0a7d 0a0a 766f 6964 2043 6c69 656e  );.}..void Clien
00000490: 743a 3a53 6574 5368 6172 6564 466f 6c64  t::SetSharedFold
000004a0: 6572 2863 6861 7220 2a66 6f6c 6465 7229  er(char *folder)
000004b0: 0a7b 0a20 2020 2073 7472 6370 7928 6d5f  .{.    strcpy(m_
000004c0: 7368 6172 6564 2c20 666f 6c64 6572 293b  shared, folder);
000004d0: 0a7d 0a0a 766f 6964 2043 6c69 656e 743a  .}..void Client:
000004e0: 3a53 6574 496f 7642 7566 6665 7228 290a  :SetIovBuffer().
000004f0: 7b0a 2020 2020 666f 7228 696e 7420 6920  {.    for(int i 
00000500: 3d20 303b 2069 203c 2049 4f56 5f4c 4953  = 0; i < IOV_LIS
00000510: 545f 434e 543b 2069 2b2b 290a 2020 2020  T_CNT; i++).    
00000520: 7b0a 2020 2020 2020 2020 6d5f 7365 6e64  {.        m_send
00000530: 5f6c 6973 745b 695d 2e69 6f76 5f62 6173  _list[i].iov_bas
00000540: 6509 2020 2020 3d20 266d 5f73 656e 645f  e.    = &m_send_
00000550: 6275 665b 695d 3b0a 2020 2020 2020 2020  buf[i];.        
00000560: 6d5f 7365 6e64 5f6c 6973 745b 695d 2e69  m_send_list[i].i
00000570: 6f76 5f6c 656e 2009 093d 2073 697a 656f  ov_len ..= sizeo
00000580: 6628 6d5f 7365 6e64 5f62 7566 293b 0a20  f(m_send_buf);. 
00000590: 2020 2020 2020 200a 2020 2020 2020 2020         .        
000005a0: 6d5f 7265 6376 5f6c 6973 745b 695d 2e69  m_recv_list[i].i
000005b0: 6f76 5f62 6173 6509 2020 2020 3d20 266d  ov_base.    = &m
000005c0: 5f72 6563 765f 6275 665b 695d 3b0a 2020  _recv_buf[i];.  
000005d0: 2020 2020 2020 6d5f 7265 6376 5f6c 6973        m_recv_lis
000005e0: 745b 695d 2e69 6f76 5f6c 656e 2009 093d  t[i].iov_len ..=
000005f0: 2073 697a 656f 6628 6d5f 7265 6376 5f62   sizeof(m_recv_b
00000600: 7566 293b 0a20 2020 207d 0a0a 2020 2020  uf);.    }..    
00000610: 6d65 6d73 6574 286d 5f73 656e 645f 6275  memset(m_send_bu
00000620: 662c 2030 2c20 7369 7a65 6f66 286d 5f73  f, 0, sizeof(m_s
00000630: 656e 645f 6275 6629 293b 0a7d 0a0a 766f  end_buf));.}..vo
00000640: 6964 2043 6c69 656e 743a 3a53 6574 506f  id Client::SetPo
00000650: 7274 2863 6861 7220 2a70 6f72 7429 0a7b  rt(char *port).{
00000660: 0a20 2020 2073 7472 6370 7928 6d5f 706f  .    strcpy(m_po
00000670: 7274 2c20 706f 7274 293b 0a7d 0a0a 0a76  rt, port);.}...v
00000680: 6f69 6420 436c 6965 6e74 3a3a 5f53 656e  oid Client::_Sen
00000690: 644c 6973 7428 6368 6172 202a 7061 7468  dList(char *path
000006a0: 2c20 7469 6d65 5f74 206d 6f64 5469 6d65  , time_t modTime
000006b0: 2c20 626f 6f6c 2066 6c61 6720 3d20 6661  , bool flag = fa
000006c0: 6c73 6529 0a7b 0a20 2020 2073 7461 7469  lse).{.    stati
000006d0: 6320 696e 7420 6943 6e74 203d 2030 3b0a  c int iCnt = 0;.
000006e0: 0a20 2020 2069 6628 666c 6167 203d 3d20  .    if(flag == 
000006f0: 7472 7565 290a 2020 2020 7b0a 2020 2020  true).    {.    
00000700: 2020 2020 6966 2869 436e 7420 213d 2030      if(iCnt != 0
00000710: 290a 2020 2020 2020 2020 7b0a 2020 2020  ).        {.    
00000720: 2020 2020 2020 2020 6464 620a 2020 2020          ddb.    
00000730: 2020 2020 2020 2020 7772 6974 6576 286d          writev(m
00000740: 5f73 6f63 6b49 6e66 6f2e 736f 636b 2c20  _sockInfo.sock, 
00000750: 6d5f 7365 6e64 5f6c 6973 742c 2069 436e  m_send_list, iCn
00000760: 7420 2b20 3129 3b0a 2020 2020 2020 2020  t + 1);.        
00000770: 2020 2020 7365 6e64 286d 5f73 6f63 6b49      send(m_sockI
00000780: 6e66 6f2e 736f 636b 2c20 4e55 4c4c 2c20  nfo.sock, NULL, 
00000790: 302c 204d 5347 5f4f 4f42 293b 0a20 2020  0, MSG_OOB);.   
000007a0: 2020 2020 207d 0a20 2020 200a 2020 2020       }.    .    
000007b0: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
000007c0: 7d0a 0a20 2020 2073 7472 6370 7928 6d5f  }..    strcpy(m_
000007d0: 7365 6e64 5f62 7566 5b69 436e 745d 2e62  send_buf[iCnt].b
000007e0: 7566 2c20 7061 7468 293b 0a20 2020 206d  uf, path);.    m
000007f0: 5f73 656e 645f 6275 665b 6943 6e74 5d2e  _send_buf[iCnt].
00000800: 6d6f 6454 696d 6520 3d20 6d6f 6454 696d  modTime = modTim
00000810: 653b 0a20 2020 2073 7472 6370 7928 6d5f  e;.    strcpy(m_
00000820: 7365 6e64 5f62 7566 5b69 436e 745d 2e70  send_buf[iCnt].p
00000830: 6f72 742c 206d 5f70 6f72 7429 3b0a 2020  ort, m_port);.  
00000840: 2020 0a20 2020 2069 436e 742b 2b3b 0a0a    .    iCnt++;..
00000850: 2020 2020 6966 2869 436e 7420 3d3d 2031      if(iCnt == 1
00000860: 3029 2020 200a 2020 2020 7b0a 2020 2020  0)   .    {.    
00000870: 2020 2020 7772 6974 6576 286d 5f73 6f63      writev(m_soc
00000880: 6b49 6e66 6f2e 736f 636b 2c20 6d5f 7365  kInfo.sock, m_se
00000890: 6e64 5f6c 6973 742c 2049 4f56 5f4c 4953  nd_list, IOV_LIS
000008a0: 545f 434e 5429 3b0a 2020 2020 2020 2020  T_CNT);.        
000008b0: 6d65 6d73 6574 286d 5f73 656e 645f 6275  memset(m_send_bu
000008c0: 662c 2030 2c20 494f 565f 4c49 5354 5f43  f, 0, IOV_LIST_C
000008d0: 4e54 293b 0a20 2020 2020 2020 2069 436e  NT);.        iCn
000008e0: 7420 3d20 303b 0a20 2020 200a 2020 2020  t = 0;.    .    
000008f0: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
00000900: 7d0a 7d0a 0a0a 766f 6964 2043 6c69 656e  }.}...void Clien
00000910: 743a 3a45 7870 6c6f 7265 4469 7265 6374  t::ExploreDirect
00000920: 6f72 7928 6368 6172 202a 7061 7468 290a  ory(char *path).
00000930: 7b0a 2020 2020 4449 5220 2a64 6972 3b0a  {.    DIR *dir;.
00000940: 2020 2020 7374 7275 6374 2064 6972 656e      struct diren
00000950: 7420 2a65 6e74 3b0a 0a20 2020 2069 6628  t *ent;..    if(
00000960: 2864 6972 203d 206f 7065 6e64 6972 2870  (dir = opendir(p
00000970: 6174 6829 2920 3d3d 204e 554c 4c29 0a20  ath)) == NULL). 
00000980: 2020 2020 2020 2072 6574 7572 6e3b 0a0a         return;..
00000990: 2020 2020 7768 696c 6528 2865 6e74 203d      while((ent =
000009a0: 2072 6561 6464 6972 2864 6972 2929 2021   readdir(dir)) !
000009b0: 3d20 4e55 4c4c 290a 2020 2020 7b0a 2020  = NULL).    {.  
000009c0: 2020 2020 2020 6966 2821 7374 7263 6d70        if(!strcmp
000009d0: 2822 2e22 2c20 656e 742d 3e64 5f6e 616d  (".", ent->d_nam
000009e0: 6529 0a20 2020 2020 2020 207c 7c20 2173  e).        || !s
000009f0: 7472 636d 7028 222e 2e22 2c20 656e 742d  trcmp("..", ent-
00000a00: 3e64 5f6e 616d 6529 0a20 2020 2020 2020  >d_name).       
00000a10: 207c 7c20 2173 7472 636d 7028 222e 4453   || !strcmp(".DS
00000a20: 5f53 746f 7265 222c 2065 6e74 2d3e 645f  _Store", ent->d_
00000a30: 6e61 6d65 290a 2020 2020 2020 2020 7c7c  name).        ||
00000a40: 2021 7374 7263 6d70 2822 2e76 7363 6f64   !strcmp(".vscod
00000a50: 6522 2c20 656e 742d 3e64 5f6e 616d 6529  e", ent->d_name)
00000a60: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
00000a70: 6e74 696e 7565 3b0a 0a20 2020 2020 2020  ntinue;..       
00000a80: 2069 6628 656e 742d 3e64 5f74 7970 6520   if(ent->d_type 
00000a90: 3d3d 2044 545f 4449 5229 0a20 2020 2020  == DT_DIR).     
00000aa0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
00000ab0: 2063 6861 7220 6e65 7750 6174 685b 4255   char newPath[BU
00000ac0: 465f 5349 5a45 5d3b 0a20 2020 2020 2020  F_SIZE];.       
00000ad0: 2020 2020 206d 656d 7365 7428 266e 6577       memset(&new
00000ae0: 5061 7468 2c20 302c 2042 5546 5f53 495a  Path, 0, BUF_SIZ
00000af0: 4529 3b0a 2020 2020 2020 2020 2020 2020  E);.            
00000b00: 7374 7263 6174 286e 6577 5061 7468 2c20  strcat(newPath, 
00000b10: 7061 7468 293b 0a20 2020 2020 2020 2020  path);.         
00000b20: 2020 2073 7472 6361 7428 6e65 7750 6174     strcat(newPat
00000b30: 682c 2022 2f22 293b 0a20 2020 2020 2020  h, "/");.       
00000b40: 2020 2020 2073 7472 6361 7428 6e65 7750       strcat(newP
00000b50: 6174 682c 2065 6e74 2d3e 645f 6e61 6d65  ath, ent->d_name
00000b60: 293b 0a20 2020 2020 2020 2020 2020 2045  );.            E
00000b70: 7870 6c6f 7265 4469 7265 6374 6f72 7928  xploreDirectory(
00000b80: 6e65 7750 6174 6829 3b0a 2020 2020 2020  newPath);.      
00000b90: 2020 7d0a 2020 2020 2020 2020 656c 7365    }.        else
00000ba0: 0a20 2020 2020 2020 207b 2020 2020 0a20  .        {    . 
00000bb0: 2020 2020 2020 2020 2020 2063 6861 7220             char 
00000bc0: 6669 6c65 5b42 5546 5f53 495a 455d 3b0a  file[BUF_SIZE];.
00000bd0: 2020 2020 2020 2020 2020 2020 7370 7269              spri
00000be0: 6e74 6628 6669 6c65 2c20 2225 732f 2573  ntf(file, "%s/%s
00000bf0: 222c 2070 6174 682c 2065 6e74 2d3e 645f  ", path, ent->d_
00000c00: 6e61 6d65 293b 0a0a 2020 2020 2020 2020  name);..        
00000c10: 2020 2020 7374 7275 6374 2073 7461 7420      struct stat 
00000c20: 7374 6174 653b 0a20 2020 2020 2020 2020  state;.         
00000c30: 2020 2069 6628 7374 6174 2866 696c 652c     if(stat(file,
00000c40: 2026 7374 6174 6529 203d 3d20 2d31 290a   &state) == -1).
00000c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
00000c60: 6578 6974 5f6d 6573 7361 6765 2822 7374  exit_message("st
00000c70: 6174 2829 2065 7272 6f72 2122 293b 0a0a  at() error!");..
00000c80: 2020 2020 2020 2020 2020 2020 5f53 656e              _Sen
00000c90: 644c 6973 7428 6669 6c65 2c20 7374 6174  dList(file, stat
00000ca0: 652e 7374 5f6d 7469 6d65 293b 0a20 2020  e.st_mtime);.   
00000cb0: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
00000cc0: 2020 7265 7475 726e 3b0a 7d0a 0a76 6f69    return;.}..voi
00000cd0: 6420 436c 6965 6e74 3a3a 5365 6e64 4c69  d Client::SendLi
00000ce0: 7374 2829 0a7b 0a20 2020 2045 7870 6c6f  st().{.    Explo
00000cf0: 7265 4469 7265 6374 6f72 7928 6d5f 7368  reDirectory(m_sh
00000d00: 6172 6564 293b 0a20 2020 205f 5365 6e64  ared);.    _Send
00000d10: 4c69 7374 284e 554c 4c2c 204e 554c 4c2c  List(NULL, NULL,
00000d20: 2074 7275 6529 3b0a 7d0a 0a0a 766f 6964   true);.}...void
00000d30: 2043 6c69 656e 743a 3a52 6563 6569 7665   Client::Receive
00000d40: 4c69 7374 2829 0a7b 0a20 2020 2069 6e74  List().{.    int
00000d50: 2069 5265 6164 3b0a 2020 2020 434c 4e54   iRead;.    CLNT
00000d60: 5f44 4154 415f 494e 464f 2064 6174 6149  _DATA_INFO dataI
00000d70: 6e66 6f3b 0a0a 2020 2020 6368 6172 2a20  nfo;..    char* 
00000d80: 7061 7468 3b0a 2020 2020 6368 6172 2a20  path;.    char* 
00000d90: 6970 3b0a 2020 2020 6368 6172 2a20 706f  ip;.    char* po
00000da0: 7274 3b0a 0a20 2020 2077 6869 6c65 2828  rt;..    while((
00000db0: 6952 6561 6420 3d20 7265 6164 7628 6d5f  iRead = readv(m_
00000dc0: 736f 636b 496e 666f 2e73 6f63 6b2c 206d  sockInfo.sock, m
00000dd0: 5f72 6563 765f 6c69 7374 2c20 3129 2021  _recv_list, 1) !
00000de0: 3d20 3029 290a 2020 2020 7b0a 2020 2020  = 0)).    {.    
00000df0: 2020 2020 6461 7461 496e 666f 203d 206d      dataInfo = m
00000e00: 5f72 6563 765f 6275 665b 305d 3b0a 2020  _recv_buf[0];.  
00000e10: 2020 2020 2020 6966 2873 7472 6c65 6e28        if(strlen(
00000e20: 6461 7461 496e 666f 2e62 7566 2920 3d3d  dataInfo.buf) ==
00000e30: 2030 290a 2020 2020 2020 2020 2020 2020   0).            
00000e40: 6272 6561 6b3b 0a20 2020 2020 2020 200a  break;.        .
00000e50: 2020 2020 2020 2020 7061 7468 203d 2064          path = d
00000e60: 6174 6149 6e66 6f2e 6275 663b 0a20 2020  ataInfo.buf;.   
00000e70: 2020 2020 2069 7020 3d20 6461 7461 496e       ip = dataIn
00000e80: 666f 2e69 703b 0a20 2020 2020 2020 2070  fo.ip;.        p
00000e90: 6f72 7420 3d20 6461 7461 496e 666f 2e70  ort = dataInfo.p
00000ea0: 6f72 743b 0a0a 2020 2020 2020 2020 7072  ort;..        pr
00000eb0: 696e 7466 2822 2573 2025 7320 2573 205c  intf("%s %s %s \
00000ec0: 6e22 2c20 7061 7468 2c20 6970 2c20 706f  n", path, ip, po
00000ed0: 7274 293b 0a20 2020 207d 0a7d 0a0a 0a0a  rt);.    }.}....
00000ee0: 0a0a 0a0a 534f 434b 5f49 4e46 4f26 2043  ....SOCK_INFO& C
00000ef0: 6c69 656e 743a 3a47 6574 536f 636b 496e  lient::GetSockIn
00000f00: 666f 2829 0a7b 0a20 2020 2072 6574 7572  fo().{.    retur
00000f10: 6e20 6d5f 736f 636b 496e 666f 3b0a 7d0a  n m_sockInfo;.}.
